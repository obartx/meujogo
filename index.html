<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panda Jump 3D - Ultimate Skins</title>
    <style>
        :root {
            --primary: #ff4757;
            --secondary: #2f3542;
            --accent: #ffa502;
            --bg-ui: rgba(255, 255, 255, 0.95);
        }
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #a5f3fc; touch-action: none; }
        
        #ui-hud {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            pointer-events: none;
            z-index: 10;
        }
        .stat-box {
            background: rgba(15, 23, 42, 0.25);
            padding: 10px 25px;
            border-radius: 40px;
            color: white;
            font-weight: bold;
            backdrop-filter: blur(10px);
            font-size: 24px;
            border: 1.5px solid rgba(255,255,255,0.2);
        }

        #joystick-container {
            position: absolute;
            bottom: 40px;
            left: 30px;
            width: 180px; 
            height: 180px;
            background: rgba(25, 25, 35, 0.4);
            border-radius: 50%;
            touch-action: none;
            z-index: 100;
            display: none;
            border: 3px solid rgba(0, 150, 255, 0.4);
            box-shadow: 0 0 30px rgba(0, 150, 255, 0.15);
        }
        #joystick-knob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #0096ff, #0055ff);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(0, 150, 255, 0.8), inset 0 0 15px rgba(255,255,255,0.4);
            pointer-events: none;
        }

        #jump-btn {
            position: absolute;
            bottom: 40px;
            right: 30px;
            width: 120px;
            height: 120px;
            background: rgba(255, 71, 87, 0.8);
            border-radius: 50%;
            display: none;
            z-index: 100;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            border: 4px solid white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            user-select: none;
            touch-action: none;
            line-height: 1.1;
        }

        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            backdrop-filter: blur(6px);
        }

        #countdown-timer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 120px;
            font-weight: 900;
            z-index: 150;
            text-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
            pointer-events: none;
        }
        
        .countdown-anim {
            animation: pop 1s ease-out forwards;
        }

        @keyframes pop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        
        .card {
            background: var(--bg-ui);
            width: 85%;
            max-width: 400px;
            border-radius: 35px;
            padding: 30px;
            text-align: center;
        }

        .tabs { display: flex; margin-bottom: 25px; background: #f1f5f9; border-radius: 20px; padding: 5px; }
        .tab-btn { flex: 1; padding: 12px; border: none; cursor: pointer; font-weight: 800; background: transparent; border-radius: 15px; color: #64748b; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .skin-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 25px; max-height: 320px; overflow-y: auto; padding: 10px; }
        .skin-item { background: white; padding: 15px; border-radius: 25px; border: 3px solid #f1f5f9; cursor: pointer; position: relative; transition: transform 0.2s; }
        .skin-item:active { transform: scale(0.95); }
        .skin-item.selected { border-color: var(--primary); background: #fff1f2; }
        .skin-item.locked { opacity: 0.9; }
        .skin-icon { font-size: 42px; }
        .price-tag { font-size: 14px; color: #ffa502; font-weight: bold; margin-top: 5px; }

        button.main-btn {
            background: linear-gradient(135deg, #ff4757, #ff6b81);
            color: white; border: none; padding: 20px; font-size: 24px; border-radius: 25px; cursor: pointer; font-weight: 900; width: 100%;
        }

        canvas { display: block; }
    </style>
</head>
<body>

    <div id="ui-hud">
        <div class="stat-box">‚≠ê <span id="score">0</span></div>
        <div class="stat-box">üí∞ <span id="coins">0</span></div>
    </div>

    <div id="countdown-timer"></div>

    <div id="joystick-container">
        <div id="joystick-knob"></div>
    </div>

    <div id="jump-btn">PULAR<br><small style="font-size: 10px;">DUPLO JUMP</small></div>

    <div id="overlay">
        <div class="card">
            <div class="tabs">
                <button class="tab-btn active" id="btn-home" onclick="showTab('home')">IN√çCIO</button>
                <button class="tab-btn" id="btn-shop" onclick="showTab('shop')">LOJA</button>
            </div>

            <div id="home" class="tab-content active">
                <h1 id="menu-title" style="color: var(--secondary); margin: 0 0 10px 0; font-size: 32px;">Panda Jump</h1>
                <p id="menu-desc" style="color: #64748b; margin-bottom: 30px; font-weight: 500;">Colete moedas e desvie dos obst√°culos!<br>Use WASD + Espa√ßo no PC.</p>
                <button class="main-btn" onclick="startPreGame()">JOGAR!</button>
            </div>

            <div id="shop" class="tab-content">
                <h2 style="color: var(--secondary); margin: 0 0 10px 0; font-size: 22px;">Skins Exclusivas</h2>
                <p style="font-size: 12px; margin-bottom: 15px;">Moedas: <span id="shop-coins" style="font-weight: bold; color: #ffa502;">0</span></p>
                <div class="skin-grid" id="skinGrid"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Fun√ß√£o para abreviar n√∫meros
        function formatNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            return num.toString();
        }

        // Configura√ß√£o de Skins Expandida (14 skins totais)
        const SKINS = [
            { id: 'panda', name: 'Panda', icon: 'üêº', colors: { body: 0xffffff, accent: 0x222222 }, price: 0, owned: true },
            { id: 'cat', name: 'Gatinho', icon: 'üê±', colors: { body: 0xffa502, accent: 0xffffff }, price: 500, owned: false },
            { id: 'robot', name: 'Rob√¥', icon: 'ü§ñ', colors: { body: 0x94a3b8, accent: 0x38bdf8 }, price: 2500, owned: false },
            { id: 'dog', name: 'Doguinho', icon: 'üê∂', colors: { body: 0x78350f, accent: 0xfef3c7 }, price: 10000, owned: false },
            { id: 'fox', name: 'Raposa', icon: 'ü¶ä', colors: { body: 0xea580c, accent: 0xffffff }, price: 50000, owned: false },
            { id: 'tiger', name: 'Tigre', icon: 'üêØ', colors: { body: 0xf97316, accent: 0x000000 }, price: 250000, owned: false },
            { id: 'alien', name: 'Alien', icon: 'üëΩ', colors: { body: 0x22c55e, accent: 0x000000 }, price: 1000000, owned: false },
            { id: 'ghost', name: 'Fantasma', icon: 'üëª', colors: { body: 0xf8fafc, accent: 0x64748b }, price: 5000000, owned: false },
            { id: 'devil', name: 'Diabinho', icon: 'üòà', colors: { body: 0xdc2626, accent: 0x450a0a }, price: 25000000, owned: false },
            { id: 'dragon', name: 'Drag√£o', icon: 'üê≤', colors: { body: 0x15803d, accent: 0xb91c1c }, price: 100000000, owned: false },
            { id: 'wizard', name: 'Mago', icon: 'üßô', colors: { body: 0x4338ca, accent: 0xfacc15 }, price: 250000000, owned: false },
            { id: 'diamond', name: 'Diamante', icon: 'üíé', colors: { body: 0x22d3ee, accent: 0xffffff }, price: 500000000, owned: false },
            { id: 'ruby', name: 'Rubi', icon: 'üßß', colors: { body: 0xbe123c, accent: 0xffd700 }, price: 750000000, owned: false },
            { id: 'gold', name: 'Ouro Puro', icon: 'üèÜ', colors: { body: 0xfacc15, accent: 0xd97706 }, price: 1000000000, owned: false }
        ];

        let currentSkinId = 'panda';
        let totalCoins = 0;
        let sessionScore = 0;

        let scene, camera, renderer, player, platforms = [], clouds = [], items = [], obstacles = [];
        let gameActive = false;
        let clock = new THREE.Clock();
        
        // F√≠sica e Controle
        const GRAVITY = 40;
        const JUMP_FORCE = 15.5; 
        const MIN_JUMP_FORCE = 7.5;
        const PLATFORM_GAP_BASE = 7.5; 
        const LATERAL_SENSITIVITY = 0.12;
        
        let playerVelocityY = 0;
        let isJumping = false;
        let jumpsAvailable = 2;
        let isHoldingJump = false;
        let gameSpeed = 9.0;
        let moveInput = { x: 0, z: 0 };

        const keys = { w: false, a: false, s: false, d: false, space: false };

        // Joystick
        const joystickContainer = document.getElementById('joystick-container');
        const joystickKnob = document.getElementById('joystick-knob');
        let joystickActive = false;
        let joystickCenter = { x: 0, y: 0 };
        let joystickTouchId = null;

        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0xa5f3fc, 25, 75);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 18);
            camera.lookAt(0, 2, -4);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);

            const sunLight = new THREE.DirectionalLight(0xffffff, 1.2);
            sunLight.position.set(10, 30, 10);
            sunLight.castShadow = true;
            scene.add(sunLight);

            createEnvironment();
            renderShop();
            updatePlayerModel();
            setupControls();
            resetLevel();

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function setupControls() {
            // JOYSTICK (Mobile)
            const handleJoystickStart = (e) => {
                if(!gameActive || joystickActive) return;
                const touch = e.changedTouches ? e.changedTouches[0] : e;
                if (e.type === 'mousedown' && e.button !== 0) return;
                const rect = joystickContainer.getBoundingClientRect();
                joystickActive = true;
                joystickTouchId = touch.identifier !== undefined ? touch.identifier : "mouse";
                joystickCenter = { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
                updateJoystickPos(touch);
            };

            const handleJoystickMove = (e) => {
                if (!joystickActive) return;
                let targetTouch = null;
                if (e.changedTouches) {
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        if (e.changedTouches[i].identifier === joystickTouchId) {
                            targetTouch = e.changedTouches[i];
                            break;
                        }
                    }
                } else { targetTouch = e; }
                if (targetTouch) { e.preventDefault(); updateJoystickPos(targetTouch); }
            };

            const updateJoystickPos = (input) => {
                let dx = input.clientX - joystickCenter.x;
                let dy = input.clientY - joystickCenter.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const maxDist = 80;
                if (dist > maxDist) { dx *= maxDist / dist; dy *= maxDist / dist; }
                joystickKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                moveInput.x = dx / maxDist;
                moveInput.z = dy < 0 ? Math.abs(dy / maxDist) : 0;
            };

            const handleJoystickEnd = (e) => {
                if (!joystickActive) return;
                let shouldEnd = false;
                if (e.changedTouches) {
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        if (e.changedTouches[i].identifier === joystickTouchId) { shouldEnd = true; break; }
                    }
                } else { shouldEnd = true; }
                if (shouldEnd) {
                    joystickActive = false; joystickTouchId = null;
                    joystickKnob.style.transform = `translate(-50%, -50%)`;
                    if(!Object.values(keys).some(v => v)) moveInput = { x: 0, z: 0 };
                }
            };

            joystickContainer.addEventListener('touchstart', handleJoystickStart);
            window.addEventListener('touchmove', handleJoystickMove, { passive: false });
            window.addEventListener('touchend', handleJoystickEnd);
            joystickContainer.addEventListener('mousedown', handleJoystickStart);
            window.addEventListener('mousemove', handleJoystickMove);
            window.addEventListener('mouseup', handleJoystickEnd);

            const jumpBtn = document.getElementById('jump-btn');
            const startJumpUI = (e) => { if(!gameActive) return; e.preventDefault(); isHoldingJump = true; handleJump(); };
            jumpBtn.addEventListener('touchstart', startJumpUI);
            jumpBtn.addEventListener('mousedown', startJumpUI);
            window.addEventListener('mouseup', () => isHoldingJump = false);
            window.addEventListener('touchend', () => isHoldingJump = false);

            window.addEventListener('keydown', (e) => {
                const k = e.key.toLowerCase();
                if (k === 'w') keys.w = true;
                if (k === 'a') keys.a = true;
                if (k === 's') keys.s = true;
                if (k === 'd') keys.d = true;
                if (k === ' ' || k === 'spacebar') {
                    if (!keys.space && gameActive) handleJump();
                    keys.space = true; isHoldingJump = true;
                }
            });
            window.addEventListener('keyup', (e) => {
                const k = e.key.toLowerCase();
                if (k === 'w') keys.w = false; if (k === 'a') keys.a = false;
                if (k === 's') keys.s = false; if (k === 'd') keys.d = false;
                if (k === ' ' || k === 'spacebar') { keys.space = false; isHoldingJump = false; }
            });
        }

        function updateInputs() {
            if (!joystickActive) {
                let kx = 0; let kz = 0;
                if (keys.a) kx -= 1; if (keys.d) kx += 1;
                if (keys.w) kz = 1; if (keys.s) kz = -0.5;
                moveInput.x = kx; moveInput.z = kz;
            }
        }

        function createEnvironment() {
            const groundGeo = new THREE.PlaneGeometry(200, 200);
            const groundMat = new THREE.MeshPhongMaterial({ color: 0x7dd3fc });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2; ground.position.y = -15; scene.add(ground);

            for(let i = 0; i < 20; i++) {
                const cloud = new THREE.Group();
                const mat = new THREE.MeshLambertMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 });
                const size = 1 + Math.random();
                const part = new THREE.Mesh(new THREE.BoxGeometry(size*4, size, size*2.5), mat);
                cloud.add(part);
                cloud.position.set(Math.random() * 120 - 60, Math.random() * 15 + 10, -Math.random() * 150);
                scene.add(cloud); clouds.push(cloud);
            }
        }

        function updatePlayerModel() {
            if (player) scene.remove(player);
            const skinData = SKINS.find(s => s.id === currentSkinId);
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.1, 1.1, 1.1), new THREE.MeshPhongMaterial({ color: skinData.colors.body }));
            body.castShadow = true; group.add(body);
            const detailMat = new THREE.MeshPhongMaterial({ color: skinData.colors.accent });
            const earGeo = new THREE.BoxGeometry(0.35, 0.35, 0.25);
            const dL = new THREE.Mesh(earGeo, detailMat); dL.position.set(-0.45, 0.55, 0); group.add(dL);
            const dR = new THREE.Mesh(earGeo, detailMat); dR.position.set(0.45, 0.55, 0); group.add(dR);
            player = group; player.position.set(0, 1.2, 0); scene.add(player);
        }

        function createPlatform(z, forceStatic = false) {
            const colors = [0xff4757, 0x2ed573, 0xffa502, 0x1e90ff, 0x70a1ff];
            const width = forceStatic ? 6 : 4.5 + (Math.random() * 3.0);
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(width, 1.2, 4.0), new THREE.MeshPhongMaterial({ color: colors[Math.floor(Math.random() * colors.length)] }));
            mesh.position.set(forceStatic ? 0 : (Math.random() - 0.5) * 8.5, 0, z);
            mesh.receiveShadow = true;
            
            if(!forceStatic && Math.random() > 0.7) {
                mesh.userData.isMoving = true;
                mesh.userData.speed = (1.5 + Math.random()) * (Math.random() > 0.5 ? 1 : -1);
            }
            scene.add(mesh);
            platforms.push(mesh);

            if (!forceStatic && Math.random() > 0.6) spawnCoin(mesh.position.x, mesh.position.z);
            if (!forceStatic && Math.random() > 0.8) spawnObstacle(mesh);
        }

        function spawnCoin(x, z) {
            const coinGeo = new THREE.CylinderGeometry(0.5, 0.5, 0.1, 16);
            const coinMat = new THREE.MeshPhongMaterial({ color: 0xffd700, emissive: 0xaa8800 });
            const coin = new THREE.Mesh(coinGeo, coinMat);
            coin.rotation.x = Math.PI / 2;
            coin.position.set(x, 1.8, z);
            scene.add(coin);
            items.push(coin);
        }

        function spawnObstacle(parentPlatform) {
            const obsGeo = new THREE.BoxGeometry(1, 1, 1);
            const obsMat = new THREE.MeshPhongMaterial({ color: 0x222222 });
            const obs = new THREE.Mesh(obsGeo, obsMat);
            obs.position.set(parentPlatform.position.x + (Math.random() - 0.5) * 2, 1.1, parentPlatform.position.z);
            obs.userData.parent = parentPlatform;
            scene.add(obs);
            obstacles.push(obs);
        }

        function handleJump() {
            if (jumpsAvailable > 0) {
                playerVelocityY = JUMP_FORCE;
                isJumping = true;
                jumpsAvailable--;
                if (jumpsAvailable === 0) player.rotation.z += Math.PI; 
            }
        }

        function gameOver() {
            gameActive = false;
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('joystick-container').style.display = 'none';
            document.getElementById('jump-btn').style.display = 'none';
            updateUI();
            showTab('home');
        }

        function updateUI() {
            const coinStr = formatNumber(totalCoins);
            document.getElementById('coins').innerText = coinStr;
            document.getElementById('shop-coins').innerText = coinStr;
        }

        function resetLevel() {
            platforms.forEach(p => scene.remove(p)); platforms = [];
            items.forEach(i => scene.remove(i)); items = [];
            obstacles.forEach(o => scene.remove(o)); obstacles = [];
            player.position.set(0, 1.2, 0); playerVelocityY = 0; 
            isJumping = false; jumpsAvailable = 2;
            sessionScore = 0; gameSpeed = 9.0;
            document.getElementById('score').innerText = "0";
            updateUI();
            createPlatform(0, true);
            for(let i = 1; i < 8; i++) createPlatform(-i * PLATFORM_GAP_BASE);
        }

        function startPreGame() {
            resetLevel();
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('joystick-container').style.display = 'block';
            document.getElementById('jump-btn').style.display = 'flex';
            
            const timerEl = document.getElementById('countdown-timer');
            timerEl.style.display = 'block';
            let count = 3;
            const runCountdown = () => {
                timerEl.innerText = count > 0 ? count : "VAI!";
                timerEl.classList.remove('countdown-anim');
                void timerEl.offsetWidth; timerEl.classList.add('countdown-anim');
                if (count >= 0) { count--; setTimeout(runCountdown, 1000); }
                else { timerEl.style.display = 'none'; gameActive = true; }
            };
            runCountdown();
        }

        function buyOrSelectSkin(skin) {
            if (skin.owned) {
                currentSkinId = skin.id;
            } else if (totalCoins >= skin.price) {
                totalCoins -= skin.price;
                skin.owned = true;
                currentSkinId = skin.id;
                updateUI();
            }
            renderShop();
            updatePlayerModel();
        }

        function renderShop() {
            const grid = document.getElementById('skinGrid');
            grid.innerHTML = '';
            SKINS.forEach(skin => {
                const item = document.createElement('div');
                item.className = `skin-item ${skin.id === currentSkinId ? 'selected' : ''} ${!skin.owned ? 'locked' : ''}`;
                item.onclick = () => buyOrSelectSkin(skin);
                
                let content = `<div class="skin-icon">${skin.icon}</div><div style="font-size:12px; font-weight:bold">${skin.name}</div>`;
                if (!skin.owned) {
                    content += `<div class="price-tag">üí∞ ${formatNumber(skin.price)}</div>`;
                } else {
                    content += `<div style="font-size:10px; color: #22c55e; margin-top:5px; font-weight:bold">SELECIONAR</div>`;
                }
                item.innerHTML = content;
                grid.appendChild(item);
            });
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.getElementById('btn-' + tabId).classList.add('active');
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            let delta = clock.getDelta();
            if(delta > 0.1) delta = 0.016;

            clouds.forEach(c => { c.position.x += 1.0 * delta; if(c.position.x > 60) c.position.x = -60; });

            if (gameActive) {
                updateInputs();
                if (Math.abs(moveInput.x) > 0.01) player.position.x += moveInput.x * LATERAL_SENSITIVITY * 95 * delta;
                player.position.x = THREE.MathUtils.clamp(player.position.x, -10, 10);

                if (!isHoldingJump && playerVelocityY > MIN_JUMP_FORCE) playerVelocityY *= 0.82;
                playerVelocityY -= GRAVITY * delta;
                player.position.y += playerVelocityY * delta;

                if (isJumping) player.rotation.x -= 8 * delta;
                else player.rotation.x = THREE.MathUtils.lerp(player.rotation.x, 0, 0.15);
                player.rotation.z = THREE.MathUtils.lerp(player.rotation.z, 0, 0.1);

                let currentSpeed = gameSpeed + (moveInput.z * 7); 
                
                platforms.forEach(p => {
                    p.position.z += currentSpeed * delta;
                    if(p.userData.isMoving) p.position.x += p.userData.speed * delta * 2.5;
                });
                
                items.forEach(i => {
                    i.position.z += currentSpeed * delta;
                    i.rotation.y += 3 * delta;
                    if (player.position.distanceTo(i.position) < 1.2) {
                        totalCoins++;
                        updateUI();
                        scene.remove(i);
                        items = items.filter(coin => coin !== i);
                    }
                });

                obstacles.forEach(o => {
                    if (o.userData.parent) {
                        o.position.z = o.userData.parent.position.z;
                        o.position.x = o.userData.parent.position.x;
                    } else { o.position.z += currentSpeed * delta; }
                    if (player.position.distanceTo(o.position) < 1.0) gameOver();
                });

                if (platforms.length > 0 && platforms[0].position.z > 20) {
                    const oldP = platforms.shift();
                    scene.remove(oldP);
                    sessionScore++;
                    document.getElementById('score').innerText = formatNumber(sessionScore);
                    gameSpeed += 0.07;
                    createPlatform(platforms[platforms.length - 1].position.z - PLATFORM_GAP_BASE);
                    items = items.filter(i => { if(i.position.z > 20) { scene.remove(i); return false; } return true; });
                    obstacles = obstacles.filter(o => { if(o.position.z > 20) { scene.remove(o); return false; } return true; });
                }

                platforms.forEach(p => {
                    const distZ = Math.abs(player.position.z - p.position.z);
                    const distX = Math.abs(player.position.x - p.position.x);
                    const halfW = p.geometry.parameters.width / 2 + 0.4;
                    if (distZ < 2.0 && distX < halfW && playerVelocityY < 0 && player.position.y <= 1.2 && player.position.y > 0.3) {
                        player.position.y = 1.2; playerVelocityY = 0;
                        isJumping = false; jumpsAvailable = 2;
                    }
                });

                if (player.position.y < -8) gameOver();
            }
            renderer.render(scene, camera);
        }
        window.onload = init;
    </script>
</body>
</html>
